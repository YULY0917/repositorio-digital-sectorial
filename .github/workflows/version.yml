name: Update site version

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate assets/version.json (America/Santiago)
        run: |
          TZ="America/Santiago"
          ISO=$(date +"%Y-%m-%dT%H:%M:%S%z")
          ISO_FMT=$(echo "$ISO" | sed -E 's/([+-][0-9]{2})([0-9]{2})$/\1:\2/')
          LABEL=$(TZ="America/Santiago" date +"%d-%m-%Y Â· %H:%M")

          cat > assets/version.json <<EOF
          {
            "updated_at": "${ISO_FMT}",
            "label": "${LABEL}"
          }
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/version.json
          git commit -m "chore: update version.json" || exit 0
          git push
